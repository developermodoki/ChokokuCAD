<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Loader</title>
</head>
<body>
  読込中です。しばらくお待ち下さい...
  <script src="three.min.js"></script>
  <script src="GLTFLoader.js"></script>
  <script src="STLLoader.js"></script>
  <script>
  let fileName = window.opener.fileName;
  let reader = window.opener.reader;
  let isAdd = !!window.opener.isAdd;
  if (new RegExp('([^\s]+(\\.stl)$)', 'i').test(fileName)) {
    let stlBlob = reader.result;
    let loader = new THREE.STLLoader();
    loader.load(stlBlob, function(modelGeometry) {
      uploadModel = new THREE.Mesh(
        modelGeometry,
        new THREE.MeshStandardMaterial({color: 0xffffff, roughness: 0.5})
      );
      uploadModelJSON = uploadModel.toJSON();
      window.opener.setModel(uploadModelJSON, isAdd);
    }, function() {}, function() {alert('エラーが発生しました。');});
  } else if (new RegExp('([^\s]+(\\.(glb|gltf))$)', 'i').test(fileName)) {
    loader = new THREE.GLTFLoader();
    let gltfBlob = reader.result;
    loader.load(gltfBlob, function(arg) {
      uploadModel = arg.scene.children[0];
      uploadModelJSON = uploadModel.toJSON();
      if (uploadModel.geometry === undefined) {
        alert('申し訳ありませんが、この形式には対応していません。\n代わりにSTL形式でアップロードしてみてください。')
      } else {
        window.opener.setModel(uploadModelJSON, isAdd);
      }
    }, function() {}, function(e) {
      alert('エラーが発生しました。');
      console.log(e);
    });
  } else {
    alert('ファイル形式が無効です（.glb, .gltf, .stlのみ）');
  }
  </script>
</body>
</html>